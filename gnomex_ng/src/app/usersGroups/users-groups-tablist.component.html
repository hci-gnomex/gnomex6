<div class="full-width full-height background border-padding">
    <div class="full-width full-height foreground">
        <as-split (dragEnd)="onSplitDragEnd($event)">
            <as-split-area size="20">
                <mat-tab-group class="full-height flex-style" [selectedIndex]="selectedTab" (selectedTabChange)="onTabChange($event)">
                    <mat-tab label="Users" class="full-height">
                        <div class="full-height full-width flex-container-col foreground small-font">
                            <div class="full-width small-font padded">
                                <mat-form-field>
                                    <input matInput [(ngModel)]="searchText" (input)="search()" placeholder="Search by name or email...">
                                </mat-form-field>
                            </div>
                            <div class="full-width flex-grow padded-left-right small-font">
                                <ag-grid-angular id="userTable"
                                                 class="full-width full-height ag-theme-fresh"
                                                 [gridOptions]="gridOptions"
                                                 [rowData]="rowData"
                                                 [columnDefs]="columnDefs"
                                                 (rowDataChanged)="onNotifyGridRowDataChanged()"
                                                 [rowSelection]="rowSelection"
                                                 (gridReady)="onGridReady($event)"
                                                 (selectionChanged)="onSelectionChanged($event)"
                                                 [enableSorting]="true"
                                                 (gridSizeChanged)="onGridSizeChanged($event)"
                                                 [enableFilter]="true"
                                                 [enableColResize]="true">
                                </ag-grid-angular>
                            </div>
                            <div class="full-width small-font">
                                <div class="flex-container-row align-center padded">
                                    <div class="padded-right">
                                        <button mat-button (click)="newUser()">
                                            <img [src]="'./assets/user.png'" alt="">
                                            New User
                                        </button>
                                    </div>
                                    <div class="padded-right">
                                        <button mat-button (click)="deleteUser()">
                                            <img [src]="'./assets/delete.png'" alt="">
                                            Delete User
                                        </button>
                                    </div>
                                    <div class="full-height flex-grow"></div>
                                    <div>
                                        <mat-label>{{userLabel}}</mat-label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </mat-tab>
                    <mat-tab label="Groups" class="full-height">
                        <div class="full-height full-width foreground flex-container-col small-font">
                            <div class="full-width padded">
                                <mat-form-field>
                                    <input matInput [(ngModel)]="searchText" (input)="searchGroups($event)" placeholder="Enter search here...">
                                </mat-form-field>
                            </div>
                            <div class="full-width padded-bottom">
                                <mat-accordion *ngIf="secAdvisor.isSuperAdmin || secAdvisor.isAdmin">
                                    <mat-expansion-panel (opened)="panelOpenState = true"
                                                         (closed)="panelOpenState = false">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                {{panelOpenState ? 'less' : 'more'}}
                                            </mat-panel-title>
                                        </mat-expansion-panel-header>
                                        <custom-combo-box placeholder="Core facility" (optionSelected)="searchCoreFacility($event)"
                                                          displayField="facilityName" [options]="myCoreFacilitiesIManage"
                                                          valueField="value">
                                        </custom-combo-box>
                                        <mat-checkbox [(ngModel)]="externalGroup" (change)="onExternalGroupChange($event)">External</mat-checkbox>
                                        <custom-combo-box placeholder="Institution" (optionSelected)="searchInstitution($event)"
                                                          displayField="institution" [options]="institutions"
                                                          valueField="value">
                                        </custom-combo-box>
                                    </mat-expansion-panel>
                                </mat-accordion>
                            </div>
                            <div class="full-width flex-grow padded-left-right">
                                <ag-grid-angular class="full-width full-height ag-theme-fresh"
                                                 [gridOptions]="groupsGridOptions"
                                                 [rowData]="groupsData"
                                                 [columnDefs]="groupsColumnDefs"
                                                 [rowSelection]="rowSelection"
                                                 (gridReady)="onGridReady($event)"
                                                 (gridSizeChanged)="onGridSizeChanged($event)"
                                                 (selectionChanged)="onGroupsSelectionChanged($event)"
                                                 [enableSorting]="true"
                                                 [enableColResize]="true">
                                </ag-grid-angular>
                            </div>
                            <div class="full-width flex-container-row align-center padded">
                                <div class="padded-right">
                                    <button mat-button (click)="newGroup()">
                                        <img [src]="'./assets/group_add.png'" alt="">
                                        New Group
                                    </button>
                                </div>
                                <div class="padded-right">
                                    <button mat-button [disabled]="!selectedGroup" (click)="deleteGroup()">
                                        <img [src]="'./assets/delete.png'" alt="">
                                        Delete Group
                                    </button>
                                </div>
                                <div class="full-height flex-grow"></div>
                                <div>
                                    <mat-label>
                                        {{ groupLabel }}
                                    </mat-label>
                                </div>
                            </div>
                            <div *ngIf="secAdvisor.isSuperAdmin" class="full-width small-font">
                                <div class="padded-left-right-bottom">
                                    <button mat-button (click)="verify('all')">
                                        <img [src]="'./assets/email_go.png'" alt="">
                                        Verify all users
                                    </button>
                                </div>
                            </div>
                        </div>
                    </mat-tab>
                </mat-tab-group>
            </as-split-area>
            <as-split-area size="80">
                <div *ngIf="isUserTab && selectedUser" class="full-height full-width flex-container-col background border-padding small-font">
                    <div class="full-width flex-grow">
                        <as-split direction="vertical">
                            <as-split-area size="75" class="foreground">
                                <form class="full-height full-width foreground flex-container-col" [formGroup]="userForm">
                                    <div class="reserve-height flex-container-row align-center padded">
                                        <div class="flex-grow min-width padded">
                                            <mat-form-field class="full-width">
                                                <input matInput formControlName="firstName" placeholder="First name">
                                                <mat-error *ngIf="userForm.controls['firstName'].hasError('required')">
                                                    First name is <strong>required</strong>
                                                </mat-error>
                                            </mat-form-field>
                                        </div>
                                        <div class="flex-grow min-width padded">
                                            <mat-form-field class="full-width">
                                                <input matInput formControlName="lastName" placeholder="Last Name">
                                                <mat-error *ngIf="userForm.controls['lastName'].hasError('required')">
                                                    Last name is <strong>required</strong>
                                                </mat-error>
                                            </mat-form-field>
                                        </div>
                                        <div class="flex-grow min-width padded">
                                            <mat-checkbox formControlName="isActive" (change)="onIsActiveChange($event)">
                                                User is Active
                                            </mat-checkbox>
                                        </div>
                                    </div>
                                    <div class="reserve-height flex-container-row align-center padded">
                                        <div class="flex-grow min-width padded">
                                            <mat-form-field class="full-width">
                                                <input matInput formControlName="phone" placeholder="Phone">
                                            </mat-form-field>
                                        </div>
                                        <div class="flex-grow min-width padded">
                                            <mat-form-field class="full-width">
                                                <input matInput formControlName="email" placeholder="Email">
                                                <mat-error *ngIf="emailFC.hasError('required')">Required</mat-error>
                                                <mat-error *ngIf="emailFC.hasError('email') && !emailFC.hasError('required')">Valid Email Required</mat-error>
                                            </mat-form-field>
                                        </div>
                                        <div class="flex-grow min-width padded">
                                            <mat-form-field class="full-width">
                                                <input matInput formControlName="ucscUrl" placeholder="UCSC Url">
                                            </mat-form-field>
                                        </div>
                                    </div>
                                    <div class="reserve-height flex-container-row align-center padded">
                                        <div class="flex-grow min-width padded">
                                            <mat-form-field class="full-width">
                                                <input matInput formControlName="institute" placeholder="Institution (Optional)">
                                            </mat-form-field>
                                        </div>
                                        <div class="flex-grow min-width padded">
                                            <mat-form-field class="full-width">
                                                <input matInput formControlName="department" placeholder="Department (Optional)">
                                            </mat-form-field>
                                        </div>
                                        <div class="flex-grow min-width padded">
                                        </div>
                                    </div>
                                    <div class="full-width flex-grow">
                                        <div class="full-height full-width flex-container-row padded-left-right-bottom">
                                            <div class="foreground border-padding">
                                                <!--need flex row container-->
                                                <div class="full-width flex-container-row">
                                                    <div class="full-height flex-grow">
                                                        <div class="full-height foreground flex-container-col">
                                                            <div class="large-margin-right">
                                                                <mat-radio-group class="flex-container-row" formControlName="userType" (change)="onUserTypeChange($event)">
                                                                    <mat-radio-button [value]="USER_TYPE_UNIVERSITY">University User</mat-radio-button>
                                                                    <mat-radio-button class="large-margin-left" [value]="USER_TYPE_EXTERNAL">External User</mat-radio-button>
                                                                </mat-radio-group>
                                                            </div>
                                                            <div *ngIf="usertypeFC.value===USER_TYPE_UNIVERSITY" class="full-width">
                                                                <mat-form-field class="formField">
                                                                    <input matInput formControlName="uNid" placeholder="uNID">
                                                                    <mat-error *ngIf="userForm.controls['uNid'].hasError('required') || userForm.controls['uNid'].hasError('pattern')">Invalid uNID</mat-error>
                                                                </mat-form-field>
                                                            </div>
                                                            <div *ngIf="usertypeFC.value===USER_TYPE_EXTERNAL" class="full-width">
                                                                <div class="full-width">
                                                                    <mat-form-field class="formField">
                                                                        <input matInput formControlName="userName" placeholder="User name">
                                                                        <mat-error *ngIf="usernameFC.hasError('required')">
                                                                            Required
                                                                        </mat-error>
                                                                    </mat-form-field>
                                                                </div>
                                                                <div class="full-width">
                                                                    <mat-form-field class="formField">
                                                                        <input matInput matTooltip="Passwords must be 8-25 characters long, contain no spaces or slashes, and contain all of the following: lowercase letter, uppercase letter, digit, or symbol." type="password" formControlName="password" placeholder="Password">
                                                                        <mat-error *ngIf="passwordFC.hasError('validatePassword')">
                                                                            {{ passwordUtilService.PASSWORD_COMPLEXITY_ERROR }}
                                                                        </mat-error>
                                                                    </mat-form-field>
                                                                </div>
                                                                <div class="full-width">
                                                                    <mat-form-field class="formField">
                                                                        <input matInput matTooltip="Passwords must be 8-25 characters long, contain no spaces or slashes, and contain all of the following: lowercase letter, uppercase letter, digit, or symbol." type="password" formControlName="passwordConfirm" placeholder="Confirm Password">
                                                                        <mat-error *ngIf="passwordConfirmFC.hasError('validatePasswordConfirm')">
                                                                            {{ passwordUtilService.PASSWORD_MATCH_ERROR }}
                                                                        </mat-error>
                                                                    </mat-form-field>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="small-width large-margin-left">
                                                        <div class="full-height foreground flex-container-col">
                                                            <label>
                                                                Permission Level
                                                            </label>
                                                            <div class="full-width flex-grow">
                                                                <mat-radio-group class="flex-container-col full-width" formControlName="permissionLevel" (change)="onPermissionLevelChange($event)">
                                                                    <mat-radio-button value="LAB">Group</mat-radio-button>
                                                                    <mat-radio-button value="ADMIN">Admin</mat-radio-button>
                                                                    <mat-radio-button value="BILLING">Billing Admin</mat-radio-button>
                                                                    <mat-radio-button value="SUPER" [disabled] = !secAdvisor.isSuperAdmin>Super Admin</mat-radio-button>
                                                                </mat-radio-group>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngIf="codeUserPermissionKind==='BILLING'||codeUserPermissionKind==='ADMIN'" class="foreground border-padding margin-left">
                                                <div class="full-width full-height large-padding-right">
                                                    <label class="full-width">Core facilities this user manages</label>
                                                    <div class="flex-container-col">
                                                        <mat-checkbox *ngFor="let cfm of coreFacilitiesIManage" [checked]=cfm.isSelected [formControlName]=cfm.mDisplay>
                                                            {{cfm.display}}
                                                        </mat-checkbox>
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngIf="codeUserPermissionKind!=='SUPER' && codeUserPermissionKind!=='ADMIN' && (secAdvisor.isSuperAdmin||secAdvisor.isBillingAdmin)" class="foreground border-padding margin-left">
                                                <div class="full-width full-height large-padding-right">
                                                    <div class="flex-container-row align-center">
                                                        <label class="full-width">Submit experiments in all labs in core</label>
                                                        <context-help name="SubmitterPermissionHelp" tooltipPosition="right"
                                                                      [hasEditPermission]="secAdvisor.isSuperAdmin"
                                                                      popupTitle="Submitter Help"></context-help>
                                                    </div>
                                                    <div class="flex-container-col">
                                                        <mat-checkbox *ngFor="let cf of coreFacilitiesICanSubmitTo" [checked]=cf.isSelected [formControlName]=cf.display>
                                                            {{cf.display}}
                                                        </mat-checkbox>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </as-split-area>
                            <as-split-area size="25">
                                <div class="full-height full-width flex-container-row foreground padded">
                                    <div class="flex-grow">
                                        <ag-grid-angular class="full-height full-width ag-theme-fresh"
                                                         [gridOptions]="labGridOptions"
                                                         [rowData]="labs"
                                                         [columnDefs]="labColumnDefs"
                                                         [rowSelection]="rowSelection"
                                                         (gridReady)="onGridReady($event)"
                                                         [enableSorting]="true">
                                        </ag-grid-angular>
                                    </div>
                                    <div class="horizontal-spacer">
                                    </div>
                                    <div class="flex-grow">
                                        <ag-grid-angular class="full-height full-width ag-theme-fresh"
                                                         [gridOptions]="collGridOptions"
                                                         [rowData]="collaboratingLabs"
                                                         [columnDefs]="collColumnDefs"
                                                         [rowSelection]="rowSelection"
                                                         (gridReady)="onGridReady($event)"
                                                         [enableSorting]="true">
                                        </ag-grid-angular>
                                    </div>
                                    <div class="horizontal-spacer">
                                    </div>
                                    <div class="flex-grow">
                                        <ag-grid-angular class="full-height full-width ag-theme-fresh"
                                                         [gridOptions]="manGridOptions"
                                                         [rowData]="managingLabs"
                                                         [columnDefs]="manColumnDefs"
                                                         [rowSelection]="rowSelection"
                                                         (gridReady)="onGridReady($event)"
                                                         (gridSizeChanged)="onManGridSizeChanged()"
                                                         [enableSorting]="true">
                                        </ag-grid-angular>
                                    </div>
                                </div>
                            </as-split-area>
                        </as-split>
                    </div>
                    <div class="full-width right-align foreground padded-left-right-bottom">
                        <save-footer [disableSave]="userForm.invalid"
                                     [showSpinner]="showSpinner"
                                     [dirty]="userForm.dirty"
                                     [icon]="constantsService.ICON_SAVE"
                                     (saveClicked)="saveUser()">
                            Save
                        </save-footer>
                    </div>
                </div>
                <div *ngIf="isGroupsTab && selectedGroup" class="full-height full-width flex-container-col">
                    <mat-tab-group class="full-width flex-grow" [selectedIndex]="selectedGroupTab">
                        <mat-tab label="Group" class="full-height">
                            <div class="full-height full-width background border-padding">
                                <div class="full-height full-width foreground flex-container-col">
                                    <form class="full-width padded" [formGroup]="groupForm">
                                        <div class="flex-container-row align-baseline">
                                            <div class="flex-grow min-width padded">
                                                <mat-form-field class="full-width">
                                                    <input matInput formControlName="firstName" placeholder="First name">
                                                    <mat-error *ngIf="groupForm.controls['firstName'].hasError('incorrect')">
                                                        First name or Last name <strong>required</strong>
                                                    </mat-error>
                                                </mat-form-field>
                                            </div>
                                            <div class="flex-grow min-width padded">
                                                <mat-form-field class="full-width">
                                                    <input matInput formControlName="lastName" placeholder="Last Name (or lab name)">
                                                    <mat-error *ngIf="groupForm.controls['lastName'].hasError('incorrect')">
                                                        Last name or First name <strong>required</strong>
                                                    </mat-error>
                                                </mat-form-field>
                                            </div>
                                            <div class="flex-grow min-width padded">
                                                <mat-checkbox [checked]="isActive_lab" [disabled]="disable_isActive_lab" (change)="onChange_isActive($event)">
                                                    Lab is Active
                                                </mat-checkbox>
                                            </div>
                                        </div>
                                        <div class="flex-container-row">
                                            <div class="flex-grow min-width padded">
                                                <mat-form-field class="full-width">
                                                    <input matInput formControlName="contactPhone" placeholder="Phone">
                                                </mat-form-field>
                                            </div>
                                            <div class="flex-grow min-width padded">
                                                <mat-form-field class="full-width">
                                                    <input matInput formControlName="contactEmail" placeholder="Email">
                                                    <mat-hint>PI gets billing emails + notifications.</mat-hint>
                                                    <mat-error *ngIf="groupEmailFC.hasError('required')">Required</mat-error>
                                                    <mat-error *ngIf="groupEmailFC.hasError('email') && !groupEmailFC.hasError('required')">Valid Email Required</mat-error>
                                                </mat-form-field>
                                            </div>
                                            <div class="flex-grow min-width padded">
                                            </div>
                                        </div>
                                        <div class="flex-container-row">
                                            <div class="flex-grow min-width padded">
                                                <mat-form-field class="full-width">
                                                    <input matInput formControlName="awsAccountNumber" placeholder="AWS Account Number">
                                                </mat-form-field>
                                            </div>
                                            <div class="flex-grow min-width padded">
                                            </div>
                                        </div>
                                        <div class="full-width flex-container-row padded-top">
                                            <div class="height-auto flex-grow foreground border-padding">
                                                <!--need flex row container-->
                                                <div class="full-width full-height foreground flex-container-col">
                                                    <label>Pricing</label>
                                                    <div class="full-width flex-grow">
                                                        <mat-radio-group class="flex-container-col full-width" formControlName="pricing">
                                                            <mat-radio-button class="padded-left-right" value="INTERNAL">
                                                                <img [src]="'./assets/group.png'" alt="">
                                                                Internal
                                                            </mat-radio-button>
                                                            <mat-radio-button class="padded-left-right" value="EXACADEMIC">
                                                                <img [src]="'./assets/graduation_cap.png'" alt="">
                                                                External Academic
                                                            </mat-radio-button>
                                                            <mat-radio-button class="padded-left-right" value="EXCOMM">
                                                                <img [src]="'./assets/building.png'" alt="">
                                                                External Commercial
                                                            </mat-radio-button>
                                                        </mat-radio-group>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="horizontal-spacer">
                                            </div>
                                            <div class="height-auto flex-grow foreground border-padding">
                                                <div class="flex-container-col full-width">
                                                    <label class="full-width">Core facilities</label>
                                                    <div *ngFor="let core of myCoreFacilities" class="padded-left-right-top">
                                                        <mat-checkbox [formControlName]="core.display">
                                                            {{core.display}}
                                                        </mat-checkbox>
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngIf="showInstitutions" class="horizontal-spacer">
                                            </div>
                                            <div class="full-width flex-container-row institution-div" *ngIf="showInstitutions">
                                                <div class="height-auto flex-grow foreground border-padding">
                                                    <div class="full-width full-height foreground flex-container-col">
                                                        <div class="flex-container-row align-center spaced-children-margin">
                                                            <label>Institutions</label>
                                                            <button mat-button (click)="onEditInstitutions()" class="color-blue">Edit...</button>
                                                        </div>
                                                        <div class="flex-container-row align-center spaced-children-margin">
                                                            <custom-combo-box class="half-width" [formControl]="institutionToAddControl"
                                                                              placeholder="Institution" [options]="institutions" [displayField]="'display'">
                                                            </custom-combo-box>
                                                            <div>
                                                                <button mat-raised-button (click)="addInstitution()" [disabled]="!institutionToAddControl.value || !institutionToAddControl.value.idInstitution">
                                                                    <img [src]="constantsService.ICON_ADD" alt="">
                                                                </button>
                                                            </div>
                                                            <div>
                                                                <button mat-raised-button (click)="removeInstitution()" [disabled]="!institutionToRemove">
                                                                    <img [src]="constantsService.ICON_DELETE" alt="">
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="full-width flex-grow">
                                                            <ag-grid-angular class="full-height full-width ag-theme-balham"
                                                                             [columnDefs]="institutionGridColDefs"
                                                                             [rowSelection]="'single'"
                                                                             (gridSizeChanged)="onGridSizeChanged($event)"
                                                                             (rowSelected)="onInstitutionGridRowSelected($event)"
                                                                             (gridReady)="onInstitutionGridReady($event)">
                                                            </ag-grid-angular>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </mat-tab>
                        <mat-tab label="Billing Admin" class="full-height">
                            <div *ngIf="selectedGroup" class="full-height full-width">
                                <billing-admin-tab [group]="selectedGroup" #billingAdminTab ></billing-admin-tab>
                            </div>
                        </mat-tab>
                        <mat-tab label="Membership" class="full-height">
                            <div *ngIf="selectedGroup" class="full-height full-width">
                                <membership-tab [memberGroup]="selectedGroup" [users]="rowData" #membershipTab ></membership-tab>
                            </div>
                        </mat-tab>
                        <mat-tab label="Billing Accounts" class="full-height full-width">
                            <billing-account-tab #billingAccountTab [labInfo]="selectedGroup" (onDirty)="onManualDirty()"></billing-account-tab>
                        </mat-tab>
                        <mat-tab label="Invoices" class="full-height">
                            <div *ngIf="selectedGroup" class="full-height full-width">
                                <invoices-tab [memberGroup]="selectedGroup"></invoices-tab>
                            </div>
                        </mat-tab>
                    </mat-tab-group>
                    <div *ngIf="isGroupsTab" class="full-width flex-container-row align-center">
                        <button mat-button (click)="verify('lab')">
                            <img [src]="'./assets/email_go.png'" alt="">
                            Send email to verify users
                        </button>
                        <save-footer class="flex-grow"
                                     [dirty]="groupFormDirty"
                                     [disableSave]="groupForm.invalid"
                                     [icon]="constantsService.ICON_SAVE"
                                     [showSpinner]="showSpinner"
                                     (saveClicked)="saveLab()">
                            Save
                        </save-footer>
                    </div>
                </div>
            </as-split-area>
        </as-split>
    </div>
</div>
